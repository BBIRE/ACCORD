---
title: "RNA-Seq Exploratory Analysis"
output: html_document
date: "2024-08-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
suppressPackageStartupMessages({
  library(tidyverse)
  library(biomaRt)
  library(factoextra)
  library(ggrepel)
  library(DESeq2)
  library(enrichR)
  library(xlsx)
  library(circlize)
  library(ComplexHeatmap)
})

main_folder <- "/home/alice/ago2023/Desktop/trascrittomica/accord"
```

```{r}
count_paths <- list.files(path = file.path(main_folder,"count_data"), pattern = "quant.genes.sf", recursive = T, full.names = T)
count_lists <- lapply(count_paths, function (x) read_tsv(x, col_types = cols()))
names <- lapply(basename(count_paths), function (x) strsplit(x, split = "-")[[1]][1])
names(count_lists) <- names
counts <- count_lists %>%
  lapply(., function(df) {df %>% dplyr::select(Name,NumReads)}) %>%
  # Map(function(x, n) setNames(x, c(names(x)[1], n)), ., names(.))
  Map(function(x, n) setNames(x, c("Ensembl_ID", n)), ., names(.)) %>%
  purrr::reduce(inner_join, by = c("Ensembl_ID")) %>%
  as.data.frame(.) %>% 
  mutate_if(is.numeric, round)
write.table(counts, file.path(main_folder,"gene_counts.tsv"), quote = F, sep = "\t", row.names = F, col.names = T)
```

```{r}
tpm <- count_lists %>%
  lapply(., function(df) {df %>% dplyr::select(Name,TPM)}) %>%
  Map(function(x, n) setNames(x, c("Ensembl_ID", n)), ., names(.)) %>%
  purrr::reduce(inner_join, by = c("Ensembl_ID")) %>%
  as.data.frame(.)
```


Convert Ensembl IDs to gene names
```{r}
ensembl <- useEnsembl(biomart = "genes", dataset = "hsapiens_gene_ensembl")
genes <- data.frame(ensembl = tpm$Ensembl_ID)
# run the query
gene_IDs <- getBM(
  attributes=c("ensembl_gene_id_version","hgnc_symbol","gene_biotype"),
  filters=c("ensembl_gene_id_version"), 
  values = genes$ensembl,
  mart = ensembl)
head(gene_IDs)
```

tpm matrix is updated by matching to the retrieved annotation
```{r}
gene_IDs <- gene_IDs %>%
  filter(!hgnc_symbol=="") 

cibersort_input <- tpm %>%
  dplyr::rename("ensembl_gene_id_version" = "Ensembl_ID") %>%
  right_join(.,gene_IDs) %>%
  dplyr::select(-gene_biotype, -ensembl_gene_id_version) %>%
  group_by(hgnc_symbol) %>%
  summarise_all(mean) %>%
  column_to_rownames("hgnc_symbol") %>%
  rownames_to_column("gene_id")
head(cibersort_input)

write.table(cibersort_input, file.path(main_folder,"acc_cibersort_input.tsv"), quote = F, sep = "\t", row.names = F, col.names = T)
```


AUTOGO
```{r}
files <- list.files(path = "/home/alice/ago2023/Desktop/auto-go/R", recursive = T, all.files = T, full.names = T)
invisible(sapply(files, source))

autogo_folder <- "/home/alice/ago2023/Desktop/trascrittomica/accord/"
```

```{r}
counts <- read_tsv(file.path(main_folder,"gene_counts.tsv"), show_col_types = FALSE)

groups <- data.frame(sample = colnames(counts)[2:51],
                     group = c(rep("groupA",20), rep("groupB",15), rep("groupC",15)))

comparisons <- data.frame(treatment = "groupA",
                          control = "groupB")
```

```{r}
deseq_analysis(counts, groups, comparisons, padj_threshold = 0.01, log2FC_threshold = 1, pre_filtering = T, save_excel = T, where_results = autogo_folder, outfolder = "differential_analysis_0824/")
```




```{r}
vst <- read.table(file.path(main_folder,"differential_analysis_0824/deseq_vst_data.txt"))
colnames(vst) <- gsub("^X","",colnames(vst))

pca_data=prcomp(t(vst))
summary(pca_data)

p1 <- fviz_eig(pca_data, 
         addlabels = TRUE, 
         ylim = c(0, 70),
         main="")
p1

png(file.path(main_folder,"pca_screeplot.png"), res=300, units = "px", width=2500, height=2000)
p1
dev.off()
```

```{r}
pca_data_perc=round(100*pca_data$sdev^2/sum(pca_data$sdev^2),1)
df_pca_data = data.frame(PC1 = pca_data$x[,1], PC2 = pca_data$x[,2], sample = colnames(vst))

# PCA for components 1&2
p2 <- ggplot(df_pca_data, aes(PC1,PC2, colour = "#d95d39"))+
  geom_point(size=3)+
  scale_color_manual(values=c("#d95d39"))+
  labs(x=paste0("PC1 (",pca_data_perc[1],"% variance)"), y=paste0("PC2 (",pca_data_perc[2],"% variance)") )+
  theme(legend.position="none")
p2


# PCA with labels
p3 <- ggplot(df_pca_data, aes(PC1,PC2, colour = "#d95d39"))+
  geom_point(size=3, show.legend = F)+
  scale_color_manual(values=c("#d95d39"))+
  geom_label_repel(aes(label=sample, fill="#d95d39"), color="white", size=2, max.overlaps = Inf)+
  scale_fill_manual(values=c("#d95d39"))+
  labs(x=paste0("PC1 (",pca_data_perc[1],"% variance)"), y=paste0("PC2 (",pca_data_perc[2],"% variance)") )+
  theme(legend.position="none")
p3

png(file.path(main_folder,"PC1_vs_PC2.png"), res=300, units = "px", width=2500, height=2000)
p2
dev.off()
png(file.path(main_folder,"PC1_vs_PC2_labels.png"), res=300, units = "px", width=2500, height=2000)
p3
dev.off()

```

```{r}
# PCA for components 1&3
df_pca_data = data.frame(PC1 = pca_data$x[,1], PC3 = pca_data$x[,3], sample = colnames(vst))

p4 <- ggplot(df_pca_data, aes(PC1,PC3, colour = "#d95d39"))+
  geom_point(size=3)+
  scale_color_manual(values=c("#d95d39"))+
  labs(x=paste0("PC1 (",pca_data_perc[1],"% variance)"), y=paste0("PC3 (",pca_data_perc[3],"% variance)") )+
  theme(legend.position="none")
p4

png(file.path(main_folder,"PC1_vs_PC3.png"), res=300, units = "px", width=2500, height=2000)
p4
dev.off()
```


Hierarchical Clustering
```{r}
# feature selection
# keep top genes based on median absolute deviation
mads <- apply(vst,1,mad)
# selecting features
mad2k <- vst[rev(order(mads))[1:2000],]

# calculate distances (default: Eucledian distance)
dist_matrix <- dist(t(mad2k))
# perform hierarchical clustering using ? linkage 
hc <- hclust(dist_matrix, method = "average")
plot(hc, main = "Average Linkage", hang = -1, cex = 0.6, xlab="")
fviz_nbclust(mad2k, FUN = hcut, method = "wss")

prediction <- cutree(hc, k = 3)
prediction
```